CREATE TABLE roles (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	name VARCHAR(255) UNIQUE NOT NULL,
	description TEXT
);

CREATE TABLE project_roles (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	name VARCHAR(255) UNIQUE NOT NULL
);

CREATE TABLE currencies (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	name VARCHAR(255) NOT NULL,
	code VARCHAR(10) NOT NULL
);

CREATE TABLE action_types (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	name VARCHAR(255) NOT NULL,
	description text
);

CREATE TABLE positions (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	name VARCHAR(255) NOT NULL,
	grade grade NOT NULL,
	description text
	
	CONSTRAINT positions_name_grade_unique UNIQUE (name, grade)
);

CREATE TABLE departments (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	name VARCHAR(255) UNIQUE NOT NULL,
	description text,
	head_id UUID,
	created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE employees (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	email VARCHAR(255) UNIQUE NOT NULL
		CHECK (email ~* '^[A-Za-z0-9._+%-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'),
	phone VARCHAR(30) UNIQUE NOT NULL,
	status employee_status NOT NULL DEFAULT 'working',
	password_hash VARCHAR(255) NOT NULL,
	department_id UUID NOT NULL,
	user_role_id UUID NOT NULL,
	position_id UUID NOT NULL,
	created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
	updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
	
	FOREIGN KEY (department_id)
		REFERENCES departments(id),
	
	FOREIGN KEY (user_role_id)
		REFERENCES roles(id),
	
	FOREIGN KEY (position_id)
		REFERENCES positions(id)
);

CREATE TABLE salaries (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	employee_id UUID NOT NULL,
	base_salary MONEY NOT NULL,
	bonus MONEY NOT NULL DEFAULT 0,
	salary_date DATE NOT NULL DEFAULT CURRENT_DATE,
	currency_id UUID NOT NULL,
	
	FOREIGN KEY (employee_id)
		REFERENCES employees(id)
		ON DELETE CASCADE,
		
	FOREIGN KEY (currency_id)
		REFERENCES currencies(id),
		
	CONSTRAINT unique_employee_salary_date 
		UNIQUE (employee_id, salary_date)
);

CREATE TABLE employee_profiles (
	passport_number VARCHAR(20) PRIMARY KEY,
	employee_id UUID UNIQUE NOT NULL,
	first_name VARCHAR(255) NOT NULL,
	second_name VARCHAR(255) NOT NULL,
	middle_name VARCHAR(255),
	hire_date DATE NOT NULL,
	birth_date DATE NOT NULL,
	address VARCHAR(255),
	iban VARCHAR(34),
	picture TEXT,
	
	FOREIGN KEY (employee_id)
		REFERENCES employees(id)
		ON DELETE CASCADE,
	
	CONSTRAINT chk_hire_date_reasonable 
        CHECK (hire_date >= '2000-01-01')	
);

CREATE TABLE projects (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	name VARCHAR(255) NOT NULL,
	description text,
	start_date DATE NOT NULL DEFAULT CURRENT_DATE,
	end_date DATE,
	
	CONSTRAINT chk_start_end_dates
		CHECK (start_date <= end_date)
);

CREATE TABLE employee_projects (
	employee_id UUID NOT NULL,
	project_id UUID NOT NULL,
	role_id UUID NOT NULL,
	assigned_date DATE NOT NULL DEFAULT CURRENT_DATE,
	
	PRIMARY KEY (employee_id, project_id),
    
    FOREIGN KEY (employee_id) 
        REFERENCES employees(id) 
        ON DELETE CASCADE,
        
    FOREIGN KEY (project_id) 
        REFERENCES projects(id) 
        ON DELETE CASCADE,
        
    FOREIGN KEY (role_id) 
        REFERENCES project_roles(id),
    
    CONSTRAINT unique_employee_project 
        UNIQUE (employee_id, project_id),
    
    CONSTRAINT chk_assigned_date_reasonable 
        CHECK (assigned_date >= '2020-01-01')
);

CREATE TABLE attendances (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	employee_id UUID NOT NULL,
	date DATE NOT NULL UNIQUE,
	worked_hours INTEGER NOT NULL,
	
	FOREIGN KEY (employee_id)
		REFERENCES employees(id)
		ON DELETE CASCADE,
		
	CONSTRAINT CHECK_date_reasonable
		CHECK (date >= '2000-01-01'),
	
	CONSTRAINT check_date_today 
		CHECK (date <= CURRENT_DATE)
);

CREATE TABLE leaves (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	employee_id UUID NOT NULL,
	leave_type leave_type NOT NULL DEFAULT 'unpaid',
	start_date DATE NOT NULL DEFAULT CURRENT_DATE,
	end_date DATE NOT NULL DEFAULT CURRENT_DATE,
	status leave_status NOT NULL DEFAULT 'pending',
	
	CONSTRAINT chk_start_end_dates
		CHECK (start_date <= end_date),
	
	FOREIGN KEY (employee_id)
		REFERENCES employees(id)
		ON DELETE CASCADE
);

CREATE TABLE performance_reviews (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	employee_id UUID NOT NULL,
	reviewer_id UUID,
	score INTEGER NOT NULL,
	comments text,
	review_date DATE NOT NULL DEFAULT CURRENT_DATE,
	
	FOREIGN KEY (employee_id)
		REFERENCES employees(id),
		
	FOREIGN KEY (reviewer_id)
		REFERENCES employees(id)
);

ALTER TABLE performance_reviews 
DROP CONSTRAINT performance_reviews_employee_id_fkey;

ALTER TABLE performance_reviews 
DROP CONSTRAINT performance_reviews_reviewer_id_fkey;

ALTER TABLE performance_reviews 
ADD CONSTRAINT fk_performance_reviews_employee 
FOREIGN KEY (employee_id) REFERENCES employees(id) 
ON DELETE CASCADE;

ALTER TABLE performance_reviews 
ADD CONSTRAINT fk_performance_reviews_reviewer 
FOREIGN KEY (reviewer_id) REFERENCES employees(id) 
ON DELETE SET NULL;

CREATE TABLE audit_logs (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	employee_id UUID,
	action_type_id UUID NOT NULL,
	entity_name varchar(255) NOT NULL,
	entity_id UUID NOT NULL,
	created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
	details JSON,
	
	FOREIGN KEY (employee_id)
		REFERENCES employees(id)
		ON DELETE CASCADE,
		
	FOREIGN KEY (action_type_id)
		REFERENCES action_types(id)
		ON DELETE CASCADE
);